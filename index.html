<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Visualizador Baccarat - Roadmap Torre</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #roadmap {
      display: grid;
      grid-auto-flow: column;
      gap: 4px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      min-height: 200px;
      width: fit-content;
      margin: 20px auto;
    }
    .circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #444;
      display: inline-block;
    }
    .H {
      background-color: #f44336; /* vermelho para Home */
      border-color: #b71c1c;
    }
    .A {
      background-color: #2196f3; /* azul para Away */
      border-color: #1565c0;
    }
    .E {
      background-color: #ffeb3b; /* amarelo para Empate */
      border-color: #fbc02d;
    }
    pre#errorOutput {
      background: #f8d7da;
      border: 1px solid #f5c2c7;
      color: #842029;
      padding: 10px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 1rem;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Visualizador Baccarat - Roadmap Torre</h1>

    <div class="mb-3 d-flex align-items-center gap-3">
      <label for="fileSelector" class="form-label mb-0">Selecione o arquivo JSON:</label>
      <select id="fileSelector" class="form-select w-auto"></select>
      <button id="loadBtn" class="btn btn-primary">Carregar</button>
    </div>

    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="sourceSwitch" />
      <label class="form-check-label" for="sourceSwitch">Usar URL Externa</label>
    </div>

    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="liveSwitch" />
      <label class="form-check-label" for="liveSwitch">Live Result (Atualizar a cada 15s)</label>
    </div>

    <div id="roadmap"></div>

    <div id="stats" class="container mt-4"></div>
    <div id="streaks" class="container mt-4"></div>

    <table id="resultTable" class="table table-bordered table-striped mt-4 d-none">
      <thead class="table-light">
        <tr>
          <th>Horário</th>
          <th>Casa (Home)</th>
          <th>Visitante (Away)</th>
          <th>Resultado</th>
          <th>Troca de Baralho</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <pre id="errorOutput" style="display:none;"></pre>
  </div>

  <script>
    $(function() {
      const $fileSelector = $('#fileSelector');
      const $loadBtn = $('#loadBtn');
      const $roadmap = $('#roadmap');
      const $resultTable = $('#resultTable');
      const $tbody = $resultTable.find('tbody');
      const $sourceSwitch = $('#sourceSwitch');
      const $liveSwitch = $('#liveSwitch');
      const $stats = $('#stats');
      const $streaks = $('#streaks');
      const $errorOutput = $('#errorOutput');

      let liveInterval = null;

      function carregarListaLocal() {
        $.ajax({
          url: './data/lista.json',
          dataType: 'json',
          success: function(lista) {
            $fileSelector.empty();
            lista.forEach(function(arquivo) {
              $fileSelector.append($('<option>').val(arquivo).text(arquivo));
            });
            if (lista.length > 0) carregarArquivo(lista[0]);
            $fileSelector.prop('disabled', false);
            $errorOutput.hide().text('');
          },
          error: function(err) {
            const msg = `Erro ao carregar lista.json:\nStatus: ${err.status}\nMensagem: ${err.statusText}`;
            console.error(msg);
            $fileSelector.empty().prop('disabled', true);
            $roadmap.html('<p class="text-danger">Erro ao carregar a lista local.</p>');
            $errorOutput.show().text(msg);
          }
        });
      }

      function atualizarFonte() {
        if ($sourceSwitch.is(':checked')) {
          $fileSelector.empty().prop('disabled', true);
          carregarArquivo(null);
        } else {
          $fileSelector.prop('disabled', false);
          carregarListaLocal();
        }
      }

      $sourceSwitch.on('change', function() {
        atualizarFonte();
      });

      $loadBtn.on('click', function() {
        const arquivo = $fileSelector.val();
        carregarArquivo(arquivo);
      });

      $liveSwitch.on('change', function() {
        if ($liveSwitch.is(':checked')) {
          liveInterval = setInterval(() => {
            const arquivo = $fileSelector.val();
            carregarArquivo(arquivo);
          }, 15000);
        } else {
          clearInterval(liveInterval);
          liveInterval = null;
        }
      });

      function carregarArquivo(arquivo) {
        let url = '';
        if ($sourceSwitch.is(':checked')) {
          url = 'https://app.ingridfs.com/inc/historico.php';
        } else {
          if (!arquivo) {
            $roadmap.html('<p class="text-warning">Selecione um arquivo para carregar.</p>');
            $resultTable.addClass('d-none');
            $stats.empty();
            $streaks.empty();
            $errorOutput.hide().text('');
            return;
          }
          url = './data/' + arquivo;
        }

        $.ajax({
          url: url,
          dataType: 'text',
          success: function(text) {
            let data;
            try {
              data = JSON.parse(text.trim());
            } catch(e) {
              const msg = `Erro ao parsear JSON:\n${e.message}`;
              console.error(msg);
              $roadmap.html('<p class="text-danger">JSON inválido da URL externa.</p>');
              $resultTable.addClass('d-none');
              $stats.empty();
              $streaks.empty();
              $errorOutput.show().text(msg);
              return;
            }

            $errorOutput.hide().text('');
            data.sort((a, b) => new Date(b.horario) - new Date(a.horario));

            mostrarRoadmapTorre(data);
            mostrarTabela(data);

            const stats = calcularEstatisticas(data);
            mostrarEstatisticas(stats);

            const streaks = calcularStreaksCartasIgnorandoEmpates(data);
            mostrarStreaks(streaks);
          },
          error: function(err) {
            const msg = `Erro ao carregar os dados:\nStatus: ${err.status}\nMensagem: ${err.statusText}\nResposta: ${err.responseText || ''}`;
            console.error(msg);
            $roadmap.html('');
            $resultTable.addClass('d-none');
            $stats.empty();
            $streaks.empty();
            $errorOutput.show().text(msg);
          }
        });
      }

      // Torre sem limite, empate não quebra e mostra amarelo
      function mostrarRoadmapTorre(data) {
        $roadmap.empty();
        const colunas = [];
        let colunaAtual = [];
        let ultimoVencedorValido = null;

        for (let i = 0; i < data.length; i++) {
          const res = data[i].resultado;

          if (res === 'E') {
            colunaAtual.push('E');
            continue;
          }

          if (colunaAtual.length === 0) {
            colunaAtual.push(res);
            ultimoVencedorValido = res;
          } else if (res === ultimoVencedorValido) {
            colunaAtual.push(res);
          } else {
            colunas.push(colunaAtual);
            colunaAtual = [res];
            ultimoVencedorValido = res;
          }
        }
        if (colunaAtual.length > 0) colunas.push(colunaAtual);

        const maxAltura = colunas.reduce((max, col) => Math.max(max, col.length), 0);
        $roadmap.css('grid-template-rows', `repeat(${maxAltura}, 32px)`);

        colunas.forEach(coluna => {
          for (let i = 0; i < maxAltura; i++) {
            const resultado = coluna[i];
            const $div = $('<div>').addClass('circle');
            if (resultado) {
              $div.addClass(resultado);
            } else {
              $div.css({width: '28px', height: '28px'});
            }
            $roadmap.append($div);
          }
        });
      }

      // Mostra tabela dos dados
      function mostrarTabela(data) {
        $tbody.empty();
        data.forEach(item => {
          const tr = `<tr>
            <td>${item.horario}</td>
            <td>${item.home}</td>
            <td>${item.away}</td>
            <td>${item.resultado}</td>
            <td>${item.troca_de_baralho}</td>
          </tr>`;
          $tbody.append(tr);
        });
        $resultTable.removeClass('d-none');
      }

      // Estatísticas básicas
      function calcularEstatisticas(data) {
        const stats = {
          total: data.length,
          homeWins: 0,
          awayWins: 0,
          empates: 0,
          trocasBaralho: 0,
        };

        data.forEach(item => {
          switch (item.resultado) {
            case 'H': stats.homeWins++; break;
            case 'A': stats.awayWins++; break;
            case 'E': stats.empates++; break;
          }
          if (item.troca_de_baralho) stats.trocasBaralho++;
        });

        stats.homePercent = ((stats.homeWins / stats.total) * 100).toFixed(2);
        stats.awayPercent = ((stats.awayWins / stats.total) * 100).toFixed(2);
        stats.empatesPercent = ((stats.empates / stats.total) * 100).toFixed(2);

        return stats;
      }

      function mostrarEstatisticas(stats) {
        $stats.html(`
          <h3>Estatísticas</h3>
          <ul>
            <li>Total de jogos: ${stats.total}</li>
            <li>Vitórias Home (H): ${stats.homeWins} (${stats.homePercent}%)</li>
            <li>Vitórias Away (A): ${stats.awayWins} (${stats.awayPercent}%)</li>
            <li>Empates (E): ${stats.empates} (${stats.empatesPercent}%)</li>
            <li>Trocas de Baralho: ${stats.trocasBaralho}</li>
          </ul>
        `);
      }

      // Streaks de cartas, ignorando naipes
      function calcularStreaksCartasIgnorandoEmpates(data) {
        function limparCarta(carta) {
          return carta ? carta[0] : carta;
        }

        const streakAtual = {};
        const maiorStreak = {};

        // Ordena do mais antigo para o mais recente
        const dataOrdenada = [...data].slice().reverse();

        for (let i = 0; i < dataOrdenada.length; i++) {
          const rodada = dataOrdenada[i];
          const res = rodada.resultado;
          if (res === 'E') continue;

          let cartaAtual = null;
          if (res === 'H') cartaAtual = limparCarta(rodada.home);
          else if (res === 'A') cartaAtual = limparCarta(rodada.away);

          const proximaRodada = dataOrdenada[i + 1];
          if (!proximaRodada) {
            streakAtual[cartaAtual] = 1;
            if (!maiorStreak[cartaAtual] || streakAtual[cartaAtual] > maiorStreak[cartaAtual]) {
              maiorStreak[cartaAtual] = streakAtual[cartaAtual];
            }
            continue;
          }

          const resProx = proximaRodada.resultado;
          if (resProx === 'E') {
            streakAtual[cartaAtual] = (streakAtual[cartaAtual] || 0) + 1;
            if (!maiorStreak[cartaAtual] || streakAtual[cartaAtual] > maiorStreak[cartaAtual]) {
              maiorStreak[cartaAtual] = streakAtual[cartaAtual];
            }
            continue;
          }

          const cartaHomeProx = limparCarta(proximaRodada.home);
          const cartaAwayProx = limparCarta(proximaRodada.away);

          let cartaContinuaStreak = false;
          if (resProx === 'H' && cartaAtual === cartaHomeProx) {
            cartaContinuaStreak = true;
          } else if (resProx === 'A' && cartaAtual === cartaAwayProx) {
            cartaContinuaStreak = true;
          }

          if (cartaContin
    
