<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Visualizador Baccarat - Roadmap Torre</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    #roadmap {
      display: grid;
      grid-auto-flow: row;
      grid-template-columns: 32px;
      grid-auto-rows: 32px;
      gap: 4px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      min-height: 200px;
      width: fit-content;
      margin: 20px auto;
    }
    .circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #444;
      display: inline-block;
    }
    .H { background-color: #f44336; border-color: #d32f2f; } /* vermelho */
    .A { background-color: #2196f3; border-color: #1565c0; } /* azul */
    .E { background-color: #ffeb3b; border-color: #fbc02d; } /* amarelo */
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Visualizador Baccarat - Roadmap Torre</h1>

    <div class="mb-3 d-flex align-items-center gap-3">
      <label class="form-check-label" for="toggleSource">Usar fonte remota (live)</label>
      <input type="checkbox" id="toggleSource" />
    </div>

    <div class="mb-3" id="localSelectorContainer">
      <label for="fileSelector" class="form-label">Selecione o arquivo JSON local:</label>
      <div class="d-flex gap-2">
        <select id="fileSelector" class="form-select"></select>
        <button id="loadBtn" class="btn btn-primary">Carregar</button>
      </div>
    </div>

    <div id="roadmap"></div>

    <table id="resultTable" class="table table-bordered table-striped mt-4 d-none">
      <thead class="table-light">
        <tr>
          <th>Horário</th>
          <th>Casa</th>
          <th>Visitante</th>
          <th>Resultado</th>
          <th>Troca de Baralho</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="stats" class="mt-4"></div>
  </div>

  <script>
    const toggleSource = document.getElementById('toggleSource');
    const fileSelector = document.getElementById('fileSelector');
    const loadBtn = document.getElementById('loadBtn');
    const localSelectorContainer = document.getElementById('localSelectorContainer');
    const roadmap = document.getElementById('roadmap');
    const resultTable = document.getElementById('resultTable');
    const tbody = resultTable.querySelector('tbody');
    const statsDiv = document.getElementById('stats');

    // Função para carregar lista local de arquivos
    function carregarListaLocal() {
      fetch('./data/lista.json')
        .then(res => res.json())
        .then(lista => {
          fileSelector.innerHTML = '';
          lista.forEach(arquivo => {
            const option = document.createElement('option');
            option.value = arquivo;
            option.textContent = arquivo;
            fileSelector.appendChild(option);
          });
          if (lista.length > 0) carregarArquivoLocal(lista[0]);
        })
        .catch(err => {
          console.error('Erro ao carregar lista local:', err);
        });
    }

    // Carregar arquivo local
    function carregarArquivoLocal(arquivo) {
      fetch('./data/' + arquivo)
        .then(res => res.text())
        .then(text => {
          const jsonString = text.trim();
          let data = [];
          try {
            data = JSON.parse(jsonString);
          } catch (e) {
            console.error('Erro no parse do arquivo local:', e);
            alert('Erro no parse do arquivo local: ' + e.message);
            return;
          }
          processarDados(data);
        })
        .catch(err => {
          console.error('Erro ao carregar arquivo local:', err);
          alert('Erro ao carregar arquivo local: ' + err.message);
        });
    }

    // Carregar dados remoto
    function carregarDadosRemoto() {
      const url = 'https://app.ingridfs.com/inc/historico.php';
      fetch(url)
        .then(res => res.text())
        .then(text => {
          const jsonString = text.trim();
          let data = [];
          try {
            data = JSON.parse(jsonString);
          } catch (e) {
            console.error('Erro no parse do JSON remoto:', e);
            alert('Erro no parse do JSON remoto: ' + e.message);
            return;
          }
          processarDados(data);
        })
        .catch(err => {
          console.error('Erro ao carregar dados remotos:', err);
          alert('Erro ao carregar dados remotos: ' + err.message);
        });
    }

    // Processa dados: mostra roadmap, tabela, estatísticas
    function processarDados(data) {
      // ordenar do último para o primeiro (mais recente primeiro)
      data.sort((a, b) => new Date(b.horario) - new Date(a.horario));

      mostrarRoadmapTorre(data);
      mostrarTabela(data);
      mostrarEstatisticas(data);
    }

    // Mostra roadmap com torre única, empate segue último vencedor
    function mostrarRoadmapTorre(data) {
      roadmap.innerHTML = '';
      const colunas = [[]]; // apenas uma coluna

      let ultimoVencedorValido = null;

      for (const item of data) {
        let vencedor = item.resultado.toUpperCase();

        if (vencedor === 'E') {
          if (ultimoVencedorValido !== null) {
            vencedor = ultimoVencedorValido;
          }
          // se ultimoVencedorValido null, mantem E
        } else {
          ultimoVencedorValido = vencedor;
        }

        colunas[0].push(vencedor);
      }

      // mostra as bolinhas verticalmente
      for (const resultado of colunas[0]) {
        const div = document.createElement('div');
        div.className = 'circle ' + resultado;
        roadmap.appendChild(div);
      }
    }

    // Mostrar tabela
    function mostrarTabela(data) {
      tbody.innerHTML = '';
      if (data.length === 0) {
        resultTable.classList.add('d-none');
        return;
      }
      resultTable.classList.remove('d-none');
      for (const item of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.horario}</td>
          <td>${item.home}</td>
          <td>${item.away}</td>
          <td>${item.resultado}</td>
          <td>${item.troca_de_baralho}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Mostrar estatísticas simples (contagem de vitórias por resultado)
    function mostrarEstatisticas(data) {
      // Contar quantas vezes H e A ganharam, ignorar empate
      const contagem = { H: 0, A: 0 };

      for (const item of data) {
        const res = item.resultado.toUpperCase();
        if (res === 'H' || res === 'A') {
          contagem[res]++;
        }
      }

      statsDiv.innerHTML = `
        <h4>Estatísticas</h4>
        <p>Vitórias Casa (H): ${contagem.H}</p>
        <p>Vitórias Visitante (A): ${contagem.A}</p>
      `;
    }

    // Eventos
    toggleSource.addEventListener('change', () => {
      if (toggleSource.checked) {
        localSelectorContainer.style.display = 'none';
        carregarDadosRemoto();
      } else {
        localSelectorContainer.style.display = 'block';
        carregarListaLocal();
      }
    });

    loadBtn.addEventListener('click', () => {
      if (!toggleSource.checked) {
        const arquivo = fileSelector.value;
        carregarArquivoLocal(arquivo);
      }
    });

    // Inicializa carregando local
    carregarListaLocal();
  </script>
</body>
</html>
