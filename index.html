<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizador Baccarat - Roadmap Torre</title>
  <link href="https://https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #roadmap {
      display: grid;
      gap: 8px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      width: fit-content;
      margin: 20px auto;
      align-items: start;
    }

    .circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #444;
    }

    .H { background-color: #2196f3; border-color: #1976d2; } /* Azul - Home venceu */
    .D { background-color: #f44336; border-color: #d32f2f; } /* Vermelho - Away venceu */
    .E { background-color: #ffeb3b; border-color: #fbc02d; } /* Amarelo - Empate */
    .empty { background-color: #eee; border-color: #ccc; }

    .separator {
      width: 4px;
      background: #000;
      margin: 0 4px;
      border-radius: 2px;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Visualizador Baccarat - Roadmap Torre</h1>

    <div class="mb-3">
      <label for="fileSelector" class="form-label">Selecione o arquivo JSON:</label>
      <div class="d-flex gap-2">
        <select id="fileSelector" class="form-select"></select>
        <button id="loadBtn" class="btn btn-primary">Carregar</button>
      </div>
    </div>

    <div id="roadmap"></div>

    <table id="resultTable" class="table table-bordered table-striped mt-4 d-none">
      <thead class="table-light">
        <tr>
          <th>Horário</th>
          <th>Casa</th>
          <th>Visitante</th>
          <th>Resultado</th>
          <th>Troca de Baralho</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fileSelector = document.getElementById('fileSelector');
    const loadBtn = document.getElementById('loadBtn');
    const roadmap = document.getElementById('roadmap');
    const resultTable = document.getElementById('resultTable');
    const tbody = resultTable.querySelector('tbody');

    fetch('./data/lista.json')
      .then(res => res.json())
      .then(lista => {
        fileSelector.innerHTML = '';
        lista.forEach(arquivo => {
          const option = document.createElement('option');
          option.value = arquivo;
          option.textContent = arquivo;
          fileSelector.appendChild(option);
        });
        if (lista.length > 0) carregarArquivo(lista[0]);
      })
      .catch(error => {
        console.error('Erro ao carregar lista.json:', error);
      });

    loadBtn.addEventListener('click', () => {
      const arquivo = fileSelector.value;
      if (arquivo) carregarArquivo(arquivo);
    });

    function carregarArquivo(arquivo) {
      fetch('./data/' + arquivo)
        .then(res => res.json())
        .then(data => {
          mostrarRoadmapTorre(data);
          mostrarTabela(data);
        })
        .catch(error => {
          console.error('Erro ao carregar arquivo JSON:', error);
        });
    }

    function normalizarResultado(res) {
      switch (res) {
        case 'H': return 'H'; // Home venceu → Azul
        case 'A': return 'D'; // Away venceu → Vermelho
        case 'E': return 'E'; // Empate → Amarelo
        default: return 'E';  // Valor desconhecido → Empate
      }
    }

    function mostrarRoadmapTorre(data) {
      roadmap.innerHTML = '';
      const colunas = [];
      let colunaAtual = [];
      let ultimoResultadoPrincipal = null;

      data.forEach((item, index) => {
        const resultado = normalizarResultado(item.resultado);
        const troca = item.troca_de_baralho;
        const entrada = { resultado, troca };

        if (resultado === 'E') {
          colunaAtual.push(entrada); // empate na mesma torre
        } else {
          if (resultado !== ultimoResultadoPrincipal) {
            if (colunaAtual.length > 0) colunas.push(colunaAtual);
            colunaAtual = [entrada];
            ultimoResultadoPrincipal = resultado;
          } else {
            colunaAtual.push(entrada);
          }
        }

        // Garantir que a última coluna seja incluída
        if (index === data.length - 1 && colunaAtual.length > 0) {
          colunas.push(colunaAtual);
        }

        // Troca de baralho força quebra e inserção de separador
        if (troca && colunaAtual.length > 0) {
          colunas.push(colunaAtual);
          colunas.push('separator');
          colunaAtual = [];
          ultimoResultadoPrincipal = null;
        }
      });

      roadmap.style.gridTemplateColumns = `repeat(${colunas.length}, auto)`;
      roadmap.style.gridTemplateRows = 'auto';

      colunas.forEach(coluna => {
        if (coluna === 'separator') {
          const sep = document.createElement('div');
          sep.className = 'separator';
          roadmap.appendChild(sep);
          return;
        }

        const colunaDiv = document.createElement('div');
        colunaDiv.style.display = 'flex';
        colunaDiv.style.flexDirection = 'column';
        colunaDiv.style.gap = '4px';

        coluna.forEach(entry => {
          const div = document.createElement('div');
          div.className = 'circle ' + entry.resultado;
          colunaDiv.appendChild(div);
        });

        roadmap.appendChild(colunaDiv);
      });
    }

    function mostrarTabela(data) {
      tbody.innerHTML = '';
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.horario}</td>
          <td>${item.home}</td>
          <td>${item.away}</td>
          <td>${item.resultado}</td>
          <td>${item.troca_de_baralho}</td>
        `;
        tbody.appendChild(tr);
      });
      resultTable.classList.remove('d-none');
    }
  </script>
</body>
</html>
